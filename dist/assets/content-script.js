console.log("[OCR] content-script build v2025-08-16-3");const H=window.API_BASE_URL||"http://localhost:8000",P=!1,A=typeof navigator<"u"&&/Mac/i.test(navigator.platform);function Y(i){const r=document.createElement("template");r.innerHTML=i;const a=new Set(["B","BR","UL","LI"]),n=document.createTreeWalker(r.content,NodeFilter.SHOW_ELEMENT),c=[];for(;n.nextNode();){const e=n.currentNode;a.has(e.tagName)||c.push(e),e.tagName==="B"&&e.setAttribute("style","font-weight:bold");for(const o of[].slice.call(e.attributes))e.tagName==="B"&&o.name==="style"||e.removeAttribute(o.name)}for(let e=0;e<c.length;e++){const o=c[e],u=document.createElement("span");u.textContent=o.textContent||"",o.replaceWith(u)}return r.innerHTML}function L(i){return i=i==null?"":String(i),i.replace(/[&<>"']/g,function(r){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[r]})}function D(){const i=window.getSelection();if(!i||i.rangeCount===0)return null;const r=i.getRangeAt(0),a=i.toString().trim();if(!a)return null;try{const n=r.cloneRange();let c=r.startContainer,e=r.startOffset;if(c.nodeType===Node.TEXT_NODE){const h=c.textContent.substring(0,e).trim().split(/\s+/);if(h.length>1){const p=Math.min(2,h.length-1),y=h.slice(-p).join(" ").length+1,w=Math.max(0,e-y);n.setStart(c,w)}}let o=r.endContainer,u=r.endOffset;if(o.nodeType===Node.TEXT_NODE){const h=o.textContent.substring(u).trim().split(/\s+/);if(h.length>0){const p=Math.min(2,h.length),y=h.slice(0,p).join(" ").length;if(y>0){const w=Math.min(o.textContent.length,u+y+1);n.setEnd(o,w)}}}const l=n.toString().replace(/\s+/g," ").trim();return{selected:a,extended:l||a}}catch{return{selected:a,extended:a}}}function I(){const i=window.getSelection();if(!i||i.rangeCount===0)return"";const r=D();if(!r)return"";let n=i.getRangeAt(0).startContainer;for(;n&&n.nodeType!==Node.ELEMENT_NODE;)n=n.parentNode;if(!n||typeof n.innerText!="string")return"";const c=(n.innerText||n.textContent).replace(/\s+/g," "),e=c.match(/[^.!?。！？]+[.!?。！？]?/g)||[c],o=r.extended;let u=e.find(function(l){return l.includes(o)});return u||(u=e.find(function(l){return l.includes(r.selected)})),(u||r.selected).trim()}function S(){const i=document.getElementById("mini-translate-float");i&&i.remove(),document.removeEventListener("mousedown",j,!0)}function j(i){const r=document.getElementById("mini-translate-float");r&&!r.contains(i.target)&&S()}function F(i,r,a,n){S();const c=document.createElement("div");c.id="mini-translate-float",c.style.cssText=["position:absolute","z-index:2147483647","top:"+(a+6)+"px","left:"+r+"px","background:#fff","border:1.5px solid #d7d7d7","border-radius:10px","box-shadow:0 2px 12px 1px #0001","padding:14px 18px","min-width:210px","max-width:360px","font-size:15px","line-height:1.5","transition:box-shadow 0.1s",'font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif',"word-break:break-word"].join(";");const e="";return c.innerHTML=['<b>選字：</b><span style="color:#1e7efb">',L(i),"</span><br>",e,'<span style="color:#999;">查詢中...</span>'].join(""),document.body.appendChild(c),setTimeout(function(){document.addEventListener("mousedown",j,!0)},10),c}function N(i,r,a){const n="ocr-only-float",c=document.getElementById(n);c&&c.remove();let e=(i||"").replace(/\n{2,}/g,`

`).replace(/\s*\n\s*/g," ");const o=document.createElement("div");o.id=n,Object.assign(o.style,{position:"fixed",zIndex:"2147483647",top:`${a}px`,left:`${r}px`,background:"#fff",border:"1px solid #ddd",borderRadius:"10px",boxShadow:"0 2px 12px #0001",padding:"12px 14px",maxWidth:"420px",maxHeight:"40vh",overflow:"auto",fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial",fontSize:"14px",lineHeight:"1.5",userSelect:"text",WebkitUserSelect:"text",cursor:"text"});function u(w){return w=w==null?"":String(w),w.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}o.innerHTML=`
    <div style="font-weight:bold;margin-bottom:6px;">文字辨識結果</div>
    <div style="white-space:pre-wrap;">${u(e||"（無辨識結果）")}</div>
  `,document.body.appendChild(o);const l=12,m=o.getBoundingClientRect();let h=r,p=a;m.right>window.innerWidth-l&&(h=Math.max(l,window.innerWidth-m.width-l)),m.bottom>window.innerHeight-l&&(p=Math.max(l,window.innerHeight-m.height-l)),h<l&&(h=l),p<l&&(p=l),o.style.left=`${h}px`,o.style.top=`${p}px`;function b(w){o.contains(w.target)||(o.remove(),document.removeEventListener("mousedown",b,!0),document.removeEventListener("keydown",y,!0))}function y(w){w.key==="Escape"&&(o.remove(),document.removeEventListener("mousedown",b,!0),document.removeEventListener("keydown",y,!0))}setTimeout(()=>{document.addEventListener("mousedown",b,!0),document.addEventListener("keydown",y,!0)},10),console.log("[OCR] float mounted at",{left:h,top:p,w:m.width,h:m.height})}async function W(i,r,a){r=r||{},a=a||1e4;const n=new AbortController,c=setTimeout(function(){n.abort("timeout")},a);try{const o=await fetch(i,Object.assign({},r,{signal:n.signal})),u=await o.text();var e={};if(u)try{e=JSON.parse(u)}catch{throw new Error("Non-JSON response (HTTP "+o.status+"): "+u.slice(0,300))}if(!o.ok){const l=e&&(e.detail||e.message)||u||"HTTP "+o.status;throw new Error("HTTP "+o.status+": "+l)}return e}finally{clearTimeout(c)}}async function B(i,r,a,n){const c=F(i,r,a);try{const e=await W(H+"/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:i,context:n})},15e3),o=e&&e.normalized_target||i,u=e&&e.normalized_pos||"unknown",m={noun:"名詞",verb:"動詞",adj:"形容詞",adv:"副詞",det:"限定詞",pron:"代名詞",num:"數詞",phrase:"片語",unknown:""}[u]||"",h=m?"（"+m+"）":"";let p="";typeof e=="string"?p=e:e&&e.result?p=e.result:e&&e.text?p=e.text:e&&e.translated?p=e.translated:p="<span style='color:red'>查無翻譯</span>";const b=Y(String(p||"")),y=P?'<b>所在句：</b><span style="color:#1e7efb">'+L(n)+"</span><br>":"";c.innerHTML=['<b>選字：</b><span style="color:#1e7efb">',L(o),"</span>",h,"<br>",y,'<div style="margin:8px 0 0 0;font-size:15px;line-height:1.6;white-space:normal;">',b,"</div>",'<div style="display:flex;justify-content:flex-end;align-items:center;margin-top:8px;">','<button id="show-kg-btn" style="font-size:15px;background:linear-gradient(90deg,#257cff 40%,#0dcaf0 100%);color:#fff;border-radius:6px;border:none;padding:6px 16px;cursor:pointer;font-weight:600;box-shadow:0 1px 8px #257cff22;transition:background 0.2s;">查語意圖譜</button>','<a href="#" id="close-mini-translate" style="color:#888;margin-left:10px;font-size:15px;text-decoration:none;">關閉</a>',"</div>"].join("");const w=c.querySelector("#close-mini-translate");w&&(w.onclick=function(t){t.preventDefault(),S()});const E=c.querySelector("#show-kg-btn");E&&(E.onmouseover=function(){E.style.background="linear-gradient(90deg,#1e60c9 40%,#0da5c0 100%)"},E.onmouseout=function(){E.style.background="linear-gradient(90deg,#257cff 40%,#0dcaf0 100%)"},E.onclick=function(){try{chrome.runtime.sendMessage({type:"OPEN_GRAPH_TAB",text:n})}catch{}S()})}catch(e){console.error("翻譯 API 請求失敗:",e);const o=String(e).indexOf("timeout")>=0?"⏱️ 逾時，請重試或重新整理頁面並再次選字":"❌ 取得翻譯失敗",u="";c.innerHTML=['<b>選字：</b><span style="color:#1e7efb">',L(i),"</span><br>",u,'<div style="color:red;margin-top:8px;">',o,"</div>",'<div style="display:flex;justify-content:flex-end;margin-top:8px;">','<a href="#" id="close-mini-translate" style="color:#888;font-size:15px;text-decoration:none;">關閉</a>',"</div>"].join("");const l=c.querySelector("#close-mini-translate");l&&(l.onclick=function(m){m.preventDefault(),S()})}}if(typeof window.contentScriptLoaded>"u"){let o=function(){try{console.log.apply(console,["[OCR]"].concat([].slice.call(arguments)))}catch{}},u=function(t){let s=document.getElementById("__ocr_hud__");s||(s=document.createElement("div"),s.id="__ocr_hud__",Object.assign(s.style,{position:"fixed",top:"12px",right:"12px",zIndex:"2147483647",padding:"6px 10px",background:"#111",color:"#fff",borderRadius:"8px",font:"12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial",opacity:"0.9"}),document.body.appendChild(s)),s.textContent=t,clearTimeout(s._t),s._t=setTimeout(function(){s.remove()},1800)},l=function(){a||(a=document.createElement("div"),a.id="__ocr_overlay__",Object.assign(a.style,{position:"fixed",inset:"0",zIndex:"2147483647",background:"rgba(0,0,0,0.12)",cursor:"crosshair",pointerEvents:"auto"}),n=document.createElement("div"),Object.assign(n.style,{position:"absolute",border:"2px dashed #1976d2",background:"rgba(25,118,210,0.2)",left:"0",top:"0",width:"0",height:"0",pointerEvents:"none"}),a.appendChild(n))},m=function(){const t=document.getElementById("__ocr_overlay__");t&&t.remove(),a=null,n=null},h=function(t){return t.altKey||A&&t.metaKey||i||r},p=function(t){o("down event:",t.type),h(t)&&(t.preventDefault(),t.stopPropagation(),l(),c=t.clientX,e=t.clientY,n.style.left=c+"px",n.style.top=e+"px",n.style.width="0px",n.style.height="0px",document.body.appendChild(a))},b=function(t){if(!a||!n)return;const s=t.clientX-c,d=t.clientY-e;n.style.left=(s<0?t.clientX:c)+"px",n.style.top=(d<0?t.clientY:e)+"px",n.style.width=Math.abs(s)+"px",n.style.height=Math.abs(d)+"px"},w=function(t){const s=Array.prototype.slice.call(document.querySelectorAll("canvas"));let d=null,f=0;const g=new DOMRect(t.x,t.y,t.w,t.h);for(let x=0;x<s.length;x++){const v=s[x],T=v.getBoundingClientRect(),C=Math.max(0,Math.min(g.right,T.right)-Math.max(g.left,T.left)),k=Math.max(0,Math.min(g.bottom,T.bottom)-Math.max(g.top,T.top)),_=C*k;_>f&&(f=_,d=v)}return f>0?d:null},E=function(t,s){const d=t.getBoundingClientRect(),f=Math.max(s.x,d.left),g=Math.max(s.y,d.top),x=Math.min(s.x+s.w,d.right),v=Math.min(s.y+s.h,d.bottom),T=Math.max(0,x-f),C=Math.max(0,v-g);if(T===0||C===0)throw new Error("選取範圍不在畫面內");const k=t.width/d.width,_=t.height/d.height,X=Math.round((f-d.left)*k),z=Math.round((g-d.top)*_),O=Math.round(T*k),R=Math.round(C*_),M=document.createElement("canvas");return M.width=O,M.height=R,M.getContext("2d").drawImage(t,X,z,O,R,0,0,O,R),M.toDataURL("image/jpeg",.9)};var q=o,J=u,$=l,K=m,Z=h,G=p,Q=b,V=w,tt=E;window.contentScriptLoaded=!0,document.addEventListener("dblclick",function(t){const s=window.getSelection(),d=s?s.toString().trim():"";if(d){let f=null;s&&s.rangeCount>0&&(f=s.getRangeAt(0).getBoundingClientRect());const g=f?f.bottom+window.scrollY:t.clientY+window.scrollY,x=f?f.left+window.scrollX:t.clientX+window.scrollX,v=I();B(d,x,g,v)}}),chrome.runtime.onMessage.addListener(function(t,s,d){if(t&&t.type==="SHOW_TRANSLATE_FLOAT"&&t.text){const f=window.getSelection();let g=null;f&&f.rangeCount>0&&(g=f.getRangeAt(0).getBoundingClientRect());const x=g?g.bottom+window.scrollY:window.innerHeight/2+window.scrollY,v=g?g.left+window.scrollX:window.innerWidth/2+window.scrollX,T=I();B(t.text,v,x,T),typeof d=="function"&&d({status:"ok"})}return!0});let i=!1,r=!1,a,n,c=0,e=0;window.addEventListener("keydown",function(t){(t.key==="Alt"||A&&t.key==="Meta")&&(i=!0,o("modifier down")),String(t.key).toLowerCase()==="s"&&t.altKey&&(r=!r,u(r?"框選模式：開啟":"框選模式：關閉"),o("toggle sticky =",r)),t.key==="Escape"&&(r=!1,i=!1,m(),o("ESC -> cancel"))},!0),window.addEventListener("keyup",function(t){(t.key==="Alt"||A&&t.key==="Meta")&&(i=!1,o("modifier up"))},!0),window.addEventListener("blur",function(){i=!1,m(),o("window blur -> reset")},!0);async function y(){if(!a||!n)return;const t={x:parseInt(n.style.left,10),y:parseInt(n.style.top,10),w:parseInt(n.style.width,10),h:parseInt(n.style.height,10)};if(m(),t.w<4||t.h<4){o("tiny rect -> ignore");return}o("end rect:",t);try{const s=w(t),d=t.x+window.scrollX,f=t.y+t.h+8+window.scrollY;if(!s){N("（請在 PDF 畫面上框選：未偵測到 PDF 畫布）",d,f);return}const g=E(s,t);o("crop size:",g.length),console.log("[OCR] API_BASE_URL =",H),console.log("[OCR] payload bytes ≈",Math.round(g.length*.75));const x=await W(H+"/api/ocr",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:g,lang_hints:["en","zh-Hant"]})},2e4);console.log("[OCR] response =",x);const v=(x&&(x.text||x.result||x.ocr)||"").trim();console.log("[OCR] showing float with text length =",(v||"").length),N(v,d,f)}catch(s){o("OCR failed:",s);const d=t.x+window.scrollX,f=t.y+t.h+8+window.scrollY;N("（OCR 失敗）",d,f)}finally{i=!1}}document.addEventListener("pointerdown",p,!0),document.addEventListener("pointermove",b,!0),document.addEventListener("pointerup",y,!0),document.addEventListener("mousedown",p,!0),document.addEventListener("mousemove",b,!0),document.addEventListener("mouseup",y,!0)}
