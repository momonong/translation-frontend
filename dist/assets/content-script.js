console.log("[OCR] content-script build v2025-08-16-3");const I=window.API_BASE_URL||"http://localhost:8000",Y=!1,A=typeof navigator<"u"&&/Mac/i.test(navigator.platform);function W(r){const a=document.createElement("template");a.innerHTML=r;const s=new Set(["B","BR","UL","LI"]),o=document.createTreeWalker(a.content,NodeFilter.SHOW_ELEMENT),c=[];for(;o.nextNode();){const e=o.currentNode;s.has(e.tagName)||c.push(e),e.tagName==="B"&&e.setAttribute("style","font-weight:bold");for(const n of[].slice.call(e.attributes))e.tagName==="B"&&n.name==="style"||e.removeAttribute(n.name)}for(let e=0;e<c.length;e++){const n=c[e],p=document.createElement("span");p.textContent=n.textContent||"",n.replaceWith(p)}return a.innerHTML}function C(r){return r=r==null?"":String(r),r.replace(/[&<>"']/g,function(a){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[a]})}function N(){const r=window.getSelection();if(!r||r.rangeCount===0)return"";let s=r.getRangeAt(0).startContainer;for(;s&&s.nodeType!==Node.ELEMENT_NODE;)s=s.parentNode;if(!s||typeof s.innerText!="string")return"";const o=(s.innerText||s.textContent).replace(/\s+/g," "),c=r.toString().trim();return c?((o.match(/[^.!?。！？]+[.!?。！？]?/g)||[o]).find(function(p){return p.includes(c)})||c).trim():""}function k(){const r=document.getElementById("mini-translate-float");r&&r.remove(),document.removeEventListener("mousedown",j,!0)}function j(r){const a=document.getElementById("mini-translate-float");a&&!a.contains(r.target)&&k()}function F(r,a,s,o){k();const c=document.createElement("div");c.id="mini-translate-float",c.style.cssText=["position:absolute","z-index:2147483647","top:"+(s+6)+"px","left:"+a+"px","background:#fff","border:1.5px solid #d7d7d7","border-radius:10px","box-shadow:0 2px 12px 1px #0001","padding:14px 18px","min-width:210px","max-width:360px","font-size:15px","line-height:1.5","transition:box-shadow 0.1s",'font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif',"word-break:break-word"].join(";");const e="";return c.innerHTML=['<b>選字：</b><span style="color:#1e7efb">',C(r),"</span><br>",e,'<span style="color:#999;">查詢中...</span>'].join(""),document.body.appendChild(c),setTimeout(function(){document.addEventListener("mousedown",j,!0)},10),c}function H(r,a,s){const o="ocr-only-float",c=document.getElementById(o);c&&c.remove();let e=(r||"").replace(/\n{2,}/g,`

`).replace(/\s*\n\s*/g," ");const n=document.createElement("div");n.id=o,Object.assign(n.style,{position:"fixed",zIndex:"2147483647",top:`${s}px`,left:`${a}px`,background:"#fff",border:"1px solid #ddd",borderRadius:"10px",boxShadow:"0 2px 12px #0001",padding:"12px 14px",maxWidth:"420px",maxHeight:"40vh",overflow:"auto",fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial",fontSize:"14px",lineHeight:"1.5",userSelect:"text",WebkitUserSelect:"text",cursor:"text"});function p(w){return w=w==null?"":String(w),w.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}n.innerHTML=`
    <div style="font-weight:bold;margin-bottom:6px;">文字辨識結果</div>
    <div style="white-space:pre-wrap;">${p(e||"（無辨識結果）")}</div>
  `,document.body.appendChild(n);const u=12,m=n.getBoundingClientRect();let y=a,h=s;m.right>window.innerWidth-u&&(y=Math.max(u,window.innerWidth-m.width-u)),m.bottom>window.innerHeight-u&&(h=Math.max(u,window.innerHeight-m.height-u)),y<u&&(y=u),h<u&&(h=u),n.style.left=`${y}px`,n.style.top=`${h}px`;function b(w){n.contains(w.target)||(n.remove(),document.removeEventListener("mousedown",b,!0),document.removeEventListener("keydown",_,!0))}function _(w){w.key==="Escape"&&(n.remove(),document.removeEventListener("mousedown",b,!0),document.removeEventListener("keydown",_,!0))}setTimeout(()=>{document.addEventListener("mousedown",b,!0),document.addEventListener("keydown",_,!0)},10),console.log("[OCR] float mounted at",{left:y,top:h,w:m.width,h:m.height})}async function z(r,a,s){a=a||{},s=s||1e4;const o=new AbortController,c=setTimeout(function(){o.abort("timeout")},s);try{const n=await fetch(r,Object.assign({},a,{signal:o.signal})),p=await n.text();var e={};if(p)try{e=JSON.parse(p)}catch{throw new Error("Non-JSON response (HTTP "+n.status+"): "+p.slice(0,300))}if(!n.ok){const u=e&&(e.detail||e.message)||p||"HTTP "+n.status;throw new Error("HTTP "+n.status+": "+u)}return e}finally{clearTimeout(c)}}async function B(r,a,s,o){const c=F(r,a,s);try{const e=await z(I+"/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:r,context:o})},15e3),n=e&&e.normalized_target||r,p=e&&e.normalized_pos||"unknown",m={noun:"名詞",verb:"動詞",adj:"形容詞",adv:"副詞",det:"限定詞",pron:"代名詞",num:"數詞",phrase:"片語",unknown:""}[p]||"",y=m?"（"+m+"）":"";let h="";typeof e=="string"?h=e:e&&e.result?h=e.result:e&&e.text?h=e.text:e&&e.translated?h=e.translated:h="<span style='color:red'>查無翻譯</span>";const b=W(String(h||"")),_=Y?'<b>所在句：</b><span style="color:#1e7efb">'+C(o)+"</span><br>":"";c.innerHTML=['<b>選字：</b><span style="color:#1e7efb">',C(n),"</span>",y,"<br>",_,'<div style="margin:8px 0 0 0;font-size:15px;line-height:1.6;white-space:normal;">',b,"</div>",'<div style="display:flex;justify-content:flex-end;align-items:center;margin-top:8px;">','<button id="show-kg-btn" style="font-size:15px;background:linear-gradient(90deg,#257cff 40%,#0dcaf0 100%);color:#fff;border-radius:6px;border:none;padding:6px 16px;cursor:pointer;font-weight:600;box-shadow:0 1px 8px #257cff22;transition:background 0.2s;">查語意圖譜</button>','<a href="#" id="close-mini-translate" style="color:#888;margin-left:10px;font-size:15px;text-decoration:none;">關閉</a>',"</div>"].join("");const w=c.querySelector("#close-mini-translate");w&&(w.onclick=function(t){t.preventDefault(),k()});const v=c.querySelector("#show-kg-btn");v&&(v.onmouseover=function(){v.style.background="linear-gradient(90deg,#1e60c9 40%,#0da5c0 100%)"},v.onmouseout=function(){v.style.background="linear-gradient(90deg,#257cff 40%,#0dcaf0 100%)"},v.onclick=function(){try{chrome.runtime.sendMessage({type:"OPEN_GRAPH_TAB",text:o})}catch{}k()})}catch(e){console.error("翻譯 API 請求失敗:",e);const n=String(e).indexOf("timeout")>=0?"⏱️ 逾時，請重試或重新整理頁面並再次選字":"❌ 取得翻譯失敗",p="";c.innerHTML=['<b>選字：</b><span style="color:#1e7efb">',C(r),"</span><br>",p,'<div style="color:red;margin-top:8px;">',n,"</div>",'<div style="display:flex;justify-content:flex-end;margin-top:8px;">','<a href="#" id="close-mini-translate" style="color:#888;font-size:15px;text-decoration:none;">關閉</a>',"</div>"].join("");const u=c.querySelector("#close-mini-translate");u&&(u.onclick=function(m){m.preventDefault(),k()})}}if(typeof window.contentScriptLoaded>"u"){let n=function(){try{console.log.apply(console,["[OCR]"].concat([].slice.call(arguments)))}catch{}},p=function(t){let i=document.getElementById("__ocr_hud__");i||(i=document.createElement("div"),i.id="__ocr_hud__",Object.assign(i.style,{position:"fixed",top:"12px",right:"12px",zIndex:"2147483647",padding:"6px 10px",background:"#111",color:"#fff",borderRadius:"8px",font:"12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial",opacity:"0.9"}),document.body.appendChild(i)),i.textContent=t,clearTimeout(i._t),i._t=setTimeout(function(){i.remove()},1800)},u=function(){s||(s=document.createElement("div"),s.id="__ocr_overlay__",Object.assign(s.style,{position:"fixed",inset:"0",zIndex:"2147483647",background:"rgba(0,0,0,0.12)",cursor:"crosshair",pointerEvents:"auto"}),o=document.createElement("div"),Object.assign(o.style,{position:"absolute",border:"2px dashed #1976d2",background:"rgba(25,118,210,0.2)",left:"0",top:"0",width:"0",height:"0",pointerEvents:"none"}),s.appendChild(o))},m=function(){const t=document.getElementById("__ocr_overlay__");t&&t.remove(),s=null,o=null},y=function(t){return t.altKey||A&&t.metaKey||r||a},h=function(t){n("down event:",t.type),y(t)&&(t.preventDefault(),t.stopPropagation(),u(),c=t.clientX,e=t.clientY,o.style.left=c+"px",o.style.top=e+"px",o.style.width="0px",o.style.height="0px",document.body.appendChild(s))},b=function(t){if(!s||!o)return;const i=t.clientX-c,l=t.clientY-e;o.style.left=(i<0?t.clientX:c)+"px",o.style.top=(l<0?t.clientY:e)+"px",o.style.width=Math.abs(i)+"px",o.style.height=Math.abs(l)+"px"},w=function(t){const i=Array.prototype.slice.call(document.querySelectorAll("canvas"));let l=null,d=0;const f=new DOMRect(t.x,t.y,t.w,t.h);for(let g=0;g<i.length;g++){const x=i[g],E=x.getBoundingClientRect(),L=Math.max(0,Math.min(f.right,E.right)-Math.max(f.left,E.left)),M=Math.max(0,Math.min(f.bottom,E.bottom)-Math.max(f.top,E.top)),S=L*M;S>d&&(d=S,l=x)}return d>0?l:null},v=function(t,i){const l=t.getBoundingClientRect(),d=Math.max(i.x,l.left),f=Math.max(i.y,l.top),g=Math.min(i.x+i.w,l.right),x=Math.min(i.y+i.h,l.bottom),E=Math.max(0,g-d),L=Math.max(0,x-f);if(E===0||L===0)throw new Error("選取範圍不在畫面內");const M=t.width/l.width,S=t.height/l.height,P=Math.round((d-l.left)*M),X=Math.round((f-l.top)*S),R=Math.round(E*M),O=Math.round(L*S),T=document.createElement("canvas");return T.width=R,T.height=O,T.getContext("2d").drawImage(t,P,X,R,O,0,0,R,O),T.toDataURL("image/jpeg",.9)};var D=n,q=p,J=u,$=m,K=y,Z=h,G=b,Q=w,V=v;window.contentScriptLoaded=!0,document.addEventListener("dblclick",function(t){const i=window.getSelection(),l=i?i.toString().trim():"";if(l){let d=null;i&&i.rangeCount>0&&(d=i.getRangeAt(0).getBoundingClientRect());const f=d?d.bottom+window.scrollY:t.clientY+window.scrollY,g=d?d.left+window.scrollX:t.clientX+window.scrollX,x=N();B(l,g,f,x)}}),chrome.runtime.onMessage.addListener(function(t,i,l){if(t&&t.type==="SHOW_TRANSLATE_FLOAT"&&t.text){const d=window.getSelection();let f=null;d&&d.rangeCount>0&&(f=d.getRangeAt(0).getBoundingClientRect());const g=f?f.bottom+window.scrollY:window.innerHeight/2+window.scrollY,x=f?f.left+window.scrollX:window.innerWidth/2+window.scrollX,E=N();B(t.text,x,g,E),typeof l=="function"&&l({status:"ok"})}return!0});let r=!1,a=!1,s,o,c=0,e=0;window.addEventListener("keydown",function(t){(t.key==="Alt"||A&&t.key==="Meta")&&(r=!0,n("modifier down")),String(t.key).toLowerCase()==="s"&&t.altKey&&(a=!a,p(a?"框選模式：開啟":"框選模式：關閉"),n("toggle sticky =",a)),t.key==="Escape"&&(a=!1,r=!1,m(),n("ESC -> cancel"))},!0),window.addEventListener("keyup",function(t){(t.key==="Alt"||A&&t.key==="Meta")&&(r=!1,n("modifier up"))},!0),window.addEventListener("blur",function(){r=!1,m(),n("window blur -> reset")},!0);async function _(){if(!s||!o)return;const t={x:parseInt(o.style.left,10),y:parseInt(o.style.top,10),w:parseInt(o.style.width,10),h:parseInt(o.style.height,10)};if(m(),t.w<4||t.h<4){n("tiny rect -> ignore");return}n("end rect:",t);try{const i=w(t),l=t.x+window.scrollX,d=t.y+t.h+8+window.scrollY;if(!i){H("（請在 PDF 畫面上框選：未偵測到 PDF 畫布）",l,d);return}const f=v(i,t);n("crop size:",f.length),console.log("[OCR] API_BASE_URL =",I),console.log("[OCR] payload bytes ≈",Math.round(f.length*.75));const g=await z(I+"/api/ocr",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:f,lang_hints:["en","zh-Hant"]})},2e4);console.log("[OCR] response =",g);const x=(g&&(g.text||g.result||g.ocr)||"").trim();console.log("[OCR] showing float with text length =",(x||"").length),H(x,l,d)}catch(i){n("OCR failed:",i);const l=t.x+window.scrollX,d=t.y+t.h+8+window.scrollY;H("（OCR 失敗）",l,d)}finally{r=!1}}document.addEventListener("pointerdown",h,!0),document.addEventListener("pointermove",b,!0),document.addEventListener("pointerup",_,!0),document.addEventListener("mousedown",h,!0),document.addEventListener("mousemove",b,!0),document.addEventListener("mouseup",_,!0)}
